#include "support.h"
int user_token=0;void meta_arg(void){do{read_literal("$");if(test_flag){emit("emit_token(1);");}if(test_flag){break;}read_literal("%");if(test_flag){emit("emit_token(0);");}if(test_flag){break;}read_literal("nl");if(test_flag){emit("emit(\"\\n\");");}if(test_flag){break;}read_literal("cr");if(test_flag){emit("emit(\"\\r\");");}}while(0);}void meta_space(void){do{read_literal(".space");if(test_flag){emit("skip_whitespace();");}if(test_flag){break;}read_literal("\\");if(test_flag){emit("ignore_whitespace=1;");}if(test_flag){break;}read_literal("/");if(test_flag){emit("ignore_whitespace=0;");}}while(0);}void meta_output(void){do{read_literal("{");if(test_flag){do{do{read_string();if(test_flag){emit("emit(");emit_token(1);emit(");");}if(test_flag){break;}meta_arg();if(test_flag){}}while(0);}while(test_flag);test_flag=1;error_if_false();read_literal("}");error_if_false();}if(test_flag){break;}read_literal("<");if(test_flag){do{do{read_string();if(test_flag){emit_token(0);}if(test_flag){break;}meta_arg();if(test_flag){}}while(0);}while(test_flag);test_flag=1;error_if_false();read_literal(">");error_if_false();}}while(0);}void meta_user_token_start(void){do{read_literal(".token");if(test_flag){emit("user_token=pos;");}}while(0);}void meta_user_token_end(void){do{read_literal(".deftoken");if(test_flag){emit("make_token(user_token);");}}while(0);}void meta_user_token_delim(void){do{meta_user_token_start();if(test_flag){}if(test_flag){break;}meta_user_token_end();if(test_flag){}}while(0);}void meta_user_tokens(void){do{read_literal(".any(");if(test_flag){read_number();error_if_false();emit("read_any_between(");emit_token(1);read_literal(",");error_if_false();emit(",");read_number();error_if_false();emit_token(1);read_literal(")");error_if_false();emit(");");}if(test_flag){break;}read_literal(".but(");if(test_flag){read_number();error_if_false();emit("read_any_but(");emit_token(1);read_literal(")");error_if_false();emit(");");}if(test_flag){break;}read_literal(".eq(");if(test_flag){read_number();error_if_false();emit("read_char(");emit_token(1);read_literal(")");error_if_false();emit(");");}}while(0);}void meta_builtin_tokens(void){do{read_literal(".id");if(test_flag){emit("read_id();");}if(test_flag){break;}read_literal(".number");if(test_flag){emit("read_number();");}if(test_flag){break;}read_literal(".string");if(test_flag){emit("read_string();");}}while(0);}void meta_exp3(void){do{read_id();if(test_flag){emit("meta_");emit_token(1);emit("();");}if(test_flag){break;}read_string();if(test_flag){emit("read_literal(");emit_token(1);emit(");");}if(test_flag){break;}meta_builtin_tokens();if(test_flag){}if(test_flag){break;}meta_user_tokens();if(test_flag){}if(test_flag){break;}read_literal("(");if(test_flag){meta_exp1();error_if_false();read_literal(")");error_if_false();}if(test_flag){break;}read_literal(".e");if(test_flag){emit("test_flag=1;");}if(test_flag){break;}read_literal("*");if(test_flag){emit("do{");meta_exp3();error_if_false();emit("}while(test_flag);");emit("test_flag=1;");}}while(0);}void meta_exp2(void){do{do{meta_exp3();if(test_flag){emit("if(test_flag){");}if(test_flag){break;}do{meta_output();if(test_flag){}if(test_flag){break;}meta_space();if(test_flag){}if(test_flag){break;}meta_user_token_delim();if(test_flag){}}while(0);if(test_flag){emit("if(1){");}}while(0);if(test_flag){do{do{meta_space();if(test_flag){}if(test_flag){break;}meta_user_token_delim();if(test_flag){}if(test_flag){break;}meta_output();if(test_flag){}if(test_flag){break;}meta_exp3();if(test_flag){emit("error_if_false();");}}while(0);}while(test_flag);test_flag=1;error_if_false();emit("}");}}while(0);}void meta_exp1(void){do{emit("do{");if(1){do{meta_user_token_start();if(test_flag){}if(test_flag){break;}meta_space();if(test_flag){}if(test_flag){break;}test_flag=1;if(test_flag){}}while(0);error_if_false();meta_exp2();error_if_false();do{do{read_literal("|");if(test_flag){emit("if(test_flag){break;}");meta_exp2();error_if_false();}}while(0);}while(test_flag);test_flag=1;error_if_false();emit("}while(0);");}}while(0);}void meta_stat(void){do{read_id();if(test_flag){emit("void meta_");emit_token(1);emit("(void)");emit("{");read_literal("=");error_if_false();meta_exp1();error_if_false();read_literal(";");error_if_false();emit("}");}}while(0);}void meta_initialize(void){do{read_literal(".initialize");if(test_flag){do{do{read_string();if(test_flag){emit_token(0);}}while(0);}while(test_flag);test_flag=1;error_if_false();read_literal(";");error_if_false();}if(test_flag){break;}test_flag=1;if(test_flag){}}while(0);}void meta_finalize(void){do{read_literal(".end");if(test_flag){read_id();error_if_false();emit("\nint main(int argc, char *argv[]) {");emit("FILE *input;");emit("int length;");emit("if (argc != 3) {");emit("fprintf(stderr, \"usage: meta <input> <output>\\n\");");emit("exit(1);");emit("}");emit("input = fopen(argv[1], \"r\");");emit("if (input == NULL) {");emit("fprintf(stderr, \"invalid input file\\n\");");emit("exit(1);");emit("}");emit("output_name = argv[2];");emit("output = fopen(output_name, \"w\");");emit("if (output == NULL) {");emit("fprintf(stderr, \"invalid output file\\n\");");emit("exit(1);");emit("}");emit("fseek(input, 0, SEEK_END);");emit("input_len = length = (int)ftell(input);");emit("fseek(input, 0, SEEK_SET);");emit("source = malloc(length + 1);");emit("fread(source, 1, length, input);");emit("source[length] = \'\\0\';");emit("token = malloc(1);");emit("token[0] = \'\\0\';");emit("meta_");emit_token(0);emit("();");emit("fprintf(stderr, \"%d %d\\n\", pos, strlen(source));");emit("return 0;");emit("}");}if(test_flag){break;}read_literal(".test");if(test_flag){read_id();error_if_false();emit("\nint main (int argc, char *argv[]) {");emit("source = malloc(65535+1);");emit("int chars = read(0,source,65535);");emit("input_len = chars;");emit("source[chars] = \'\\0\';");emit("output = stdout;");emit("token = malloc(1);");emit("token[0] = \'\\0\';");emit("meta_");emit_token(0);emit("();");emit("return 0;");emit("}");}if(test_flag){break;}read_literal(".finalize");if(test_flag){do{do{read_string();if(test_flag){emit_token(0);}}while(0);}while(test_flag);test_flag=1;error_if_false();read_literal(";");error_if_false();}}while(0);}void meta_program(void){do{read_literal(".syntax");if(test_flag){read_id();error_if_false();emit("#include \"support.h\"\nint user_token=0;");meta_initialize();error_if_false();do{meta_stat();}while(test_flag);test_flag=1;error_if_false();meta_finalize();error_if_false();}}while(0);}
int main(int argc, char *argv[]) {FILE *input;int length;if (argc != 3) {fprintf(stderr, "usage: meta <input> <output>\n");exit(1);}input = fopen(argv[1], "r");if (input == NULL) {fprintf(stderr, "invalid input file\n");exit(1);}output_name = argv[2];output = fopen(output_name, "w");if (output == NULL) {fprintf(stderr, "invalid output file\n");exit(1);}fseek(input, 0, SEEK_END);input_len = length = (int)ftell(input);fseek(input, 0, SEEK_SET);source = malloc(length + 1);fread(source, 1, length, input);source[length] = '\0';token = malloc(1);token[0] = '\0';meta_program();fprintf(stderr, "%d %d\n", pos, strlen(source));return 0;}